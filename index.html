<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>UBrToVI | Unique Brand Tone of Voice Identifier</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-neutral-50 text-neutral-900">
  <div class="max-w-4xl mx-auto p-6">
    <h1 class="text-2xl font-semibold">UBrToVI</h1>
    <p class="text-sm text-neutral-600 mb-6">Map competitor tone on Pitch and Register, then find a white space for your brand.</p>

    <form id="nicheForm" class="flex gap-3 mb-4">
      <input id="niche" required class="flex-1 border rounded px-3 py-2" placeholder="eg. South African challenger banks">
      <button class="bg-black text-white px-4 py-2 rounded" type="submit">Analyse</button>
    </form>

    <div id="status" class="text-sm text-neutral-700 mb-3"></div>
    <canvas id="grid" class="w-full bg-white rounded shadow"></canvas>
    <div id="summary" class="mt-6 space-y-3"></div>
  </div>

<script>
const WORKER_URL = "https://ubrtovi-worker.ubrtovi.workers.dev"; // your live endpoint

const ctx = document.getElementById('grid').getContext('2d');
let chart;

function renderChart(data) {
  const pts = data.items.map(it => ({ x: it.pitch, y: it.register, brand: it.brand }));
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'scatter',
    data: {
      datasets: [
        { label: 'Competitors', data: pts, pointRadius: 5 },
        { label: 'Suggested', data: [{ x: data.suggestion.pitch, y: data.suggestion.register }], pointRadius: 7, pointStyle: 'triangle' }
      ]
    },
    options: {
      responsive: true,
      scales: {
        x: { title: { display: true, text: 'Pitch 1 simple 10 complex' }, min: 1, max: 10, ticks: { stepSize: 1 } },
        y: { title: { display: true, text: 'Register 1 casual 10 formal' }, min: 1, max: 10, ticks: { stepSize: 1 } }
      },
      plugins: {
        legend: { position: 'bottom' },
        tooltip: { callbacks: { label: ctx => {
          const d = ctx.raw;
          return d.brand ? `${d.brand} (${d.x}, ${d.y})` : `Suggested (${d.x}, ${d.y})`;
        }}}
      }
    }
  });
}

document.getElementById('nicheForm').addEventListener('submit', async e => {
  e.preventDefault();
  const niche = document.getElementById('niche').value.trim();
  const status = document.getElementById('status');
  const summary = document.getElementById('summary');
  status.textContent = "Analysing. Please wait.";
  summary.innerHTML = "";

  try {
    const res = await fetch(WORKER_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ niche }) });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Request failed");
    renderChart(data);

    const compList = data.items.map(it => `
      <div class="p-3 bg-white rounded shadow">
        <div class="text-sm font-medium">${it.brand}</div>
        <div class="text-xs text-neutral-600"><a href="${it.url}" target="_blank" rel="noreferrer">${it.url}</a></div>
        <div class="text-xs mt-1">Pitch ${it.pitch} | Register ${it.register}</div>
        <div class="text-xs mt-1">${it.summary}</div>
      </div>
    `).join("");

    summary.innerHTML = `
      <div class="p-4 bg-white rounded shadow">
        <div class="text-sm"><strong>Niche:</strong> ${data.niche}</div>
        <div class="text-sm mt-1"><strong>Least dense quadrant:</strong> ${data.leastDenseQuadrant}</div>
        <div class="text-sm mt-1"><strong>Suggested position:</strong> Pitch ${data.suggestion.pitch}, Register ${data.suggestion.register}</div>
        <p class="text-sm mt-3">${data.rationale}</p>
      </div>
      <h2 class="text-lg font-semibold mt-6 mb-2">Competitor tone snapshots</h2>
      <div class="grid gap-3 md:grid-cols-2">${compList}</div>
    `;

    status.textContent = "Done.";
  } catch (err) {
    status.textContent = `Error: ${err.message}`;
  }
});
</script>
</body>
</html>
